name: Build Splatter Engine

on:
  push:
    branches: [main, dev, dev2]
    paths:
      - 'engine/**'
      - 'core/**'
      - 'cython/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main, dev, dev2]
    paths:
      - 'engine/**'
      - 'core/**'
      - 'cython/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'

jobs:
  build:
    name: Build ${{ matrix.edition }} on ${{ matrix.os }}
    runs-on: ${{ matrix.runs-on }}
    
    strategy:
      matrix:
        include:
          # Linux x86-64
          - os: linux
            arch: x86-64
            runs-on: ubuntu-22.04
            edition: PRO
            preset: pro-release
            
          - os: linux
            arch: x86-64
            runs-on: ubuntu-22.04
            edition: STANDARD
            preset: standard-release

          # macOS x86-64 (Intel)
          - os: macos
            arch: x86-64
            runs-on: macos-15-intel
            edition: PRO
            preset: pro-release
            
          - os: macos
            arch: x86-64
            runs-on: macos-15-intel
            edition: STANDARD
            preset: standard-release

          # macOS arm64 (Apple Silicon)
          - os: macos
            arch: arm64
            runs-on: macos-latest
            edition: PRO
            preset: pro-release
            
          - os: macos
            arch: arm64
            runs-on: macos-latest
            edition: STANDARD
            preset: standard-release

          # Windows x86-64
          - os: windows
            arch: x86-64
            runs-on: windows-latest
            edition: PRO
            preset: pro-release
            
          - os: windows
            arch: x86-64
            runs-on: windows-latest
            edition: STANDARD
            preset: standard-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-${{ runner.arch }}-ccache-${{ hashFiles('engine/**', 'core/**', 'cython/**', 'CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-ccache-

      - name: Set up dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y \
            cmake \
            ninja-build \
            g++ \
            python3.11-dev \
            python3-pip \
            ccache
          python3.11 -m pip install --user cython numpy

      - name: Set up ccache (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
          ccache --version

      - name: Set up dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake ninja python3 cython numpy ccache

      - name: Set up ccache (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
          ccache --version

      - name: Set up dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install -y cmake ninja python ccache
          pip install cython numpy

      - name: Set up ccache (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "CCACHE_DIR=$env:USERPROFILE\.ccache" >> $env:GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $env:GITHUB_ENV
          ccache --version
        shell: pwsh

      - name: Set up CMake (all platforms)
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.30'

      - name: Configure CMake (${{ matrix.edition }})
        run: |
          export PYTHON_EXECUTABLE=/usr/bin/python3.11
          cmake --preset=${{ matrix.edition == 'PRO' && 'pro' || 'standard' }} -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DPython_EXECUTABLE=$PYTHON_EXECUTABLE
        shell: bash

      - name: Build (${{ matrix.edition }})
        run: cmake --build --preset=${{ matrix.preset }}
        shell: bash

      - name: Show ccache stats
        run: ccache --show-stats
        shell: bash

      - name: Verify binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          file splatter/bin/splatter_engine
          if command -v ldd &> /dev/null; then
            echo "=== Dynamic dependencies ==="
            ldd splatter/bin/splatter_engine || true
          elif command -v otool &> /dev/null; then
            echo "=== Dynamic dependencies (macOS) ==="
            otool -L splatter/bin/splatter_engine || true
          fi
        shell: bash

      - name: Verify binary (Windows)
        if: runner.os == 'Windows'
        run: |
          powershell -Command "file splatter/bin/splatter_engine.exe" || dir splatter\bin\splatter_engine.exe
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: splatter-engine-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.edition }}
          path: splatter/bin/splatter_engine*
          retention-days: 30

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
