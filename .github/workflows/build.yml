name: Build Splatter Engine

on:
  push:
    branches: [main, dev, dev2]
    paths:
      - 'engine/**'
      - 'core/**'
      - 'cython/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main, dev, dev2]
    paths:
      - 'engine/**'
      - 'core/**'
      - 'cython/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'

jobs:
  build:
    name: Build ${{ matrix.edition }} on ${{ matrix.os }}
    runs-on: ${{ matrix.runs-on }}
    
    strategy:
      matrix:
        include:
          # Linux x86-64
          - os: linux
            arch: x86-64
            runs-on: ubuntu-22.04
            edition: PRO
            preset: pro-release
            
          - os: linux
            arch: x86-64
            runs-on: ubuntu-22.04
            edition: STANDARD
            preset: standard-release

          # macOS x86-64 (Intel)
          - os: macos
            arch: x86-64
            runs-on: macos-15-intel
            edition: PRO
            preset: pro-release
            
          - os: macos
            arch: x86-64
            runs-on: macos-15-intel
            edition: STANDARD
            preset: standard-release

          # macOS arm64 (Apple Silicon)
          - os: macos
            arch: arm64
            runs-on: macos-latest
            edition: PRO
            preset: pro-release
            
          - os: macos
            arch: arm64
            runs-on: macos-latest
            edition: STANDARD
            preset: standard-release

          # Windows x86-64
          - os: windows
            arch: x86-64
            runs-on: windows-latest
            edition: PRO
            preset: pro-release
            
          - os: windows
            arch: x86-64
            runs-on: windows-latest
            edition: STANDARD
            preset: standard-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-${{ runner.arch }}-ccache-${{ hashFiles('engine/**', 'core/**', 'cython/**', 'CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-ccache-

      - name: Set up dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y \
            cmake \
            ninja-build \
            g++ \
            python3.11-dev \
            python3-pip \
            ccache
          python3.11 -m pip install --user cython numpy
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Set up ccache (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
          ccache --version

      - name: Install dependencies - macOS
        if: runner.os == 'macOS'
        run: |
          brew update
          # Remove conflicting symlinks before installing
          rm -f /usr/local/bin/python3.11 /usr/local/bin/python3.11-config /usr/local/bin/python3 /usr/local/bin/pip3.11 2>/dev/null || true
          rm -f /opt/homebrew/bin/python3.11 /opt/homebrew/bin/python3.11-config 2>/dev/null || true
          brew install cmake ninja python@3.11 ccache || brew link --overwrite python@3.11
          # Find Python 3.11 from brew (works on both Intel and arm64)
          PYTHON_311=$(which python3.11)
          if [ -z "$PYTHON_311" ]; then
            # Fallback to direct Cellar path lookup
            PYTHON_311=$(find /usr/local/Cellar/python@3.11 /opt/homebrew/Cellar/python@3.11 -name "python3.11" -type f 2>/dev/null | head -1)
          fi
          if [ -z "$PYTHON_311" ]; then
            echo "ERROR: Could not find python3.11"
            exit 1
          fi
          $PYTHON_311 -m pip install --break-system-packages cython numpy
        shell: bash
          
      - name: Create cython wrapper (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p /tmp/bin
          cat > /tmp/bin/cython << 'EOF'
          #!/bin/bash
          exec /tmp/bin/python3.11 -m cython "$@"
          EOF
          chmod +x /tmp/bin/cython

      - name: Set up ccache (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
          ccache --version

      - name: Set up Python 3.11 (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install -y cmake ninja ccache
          pip install cython numpy

      - name: Set up ccache (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "CCACHE_DIR=$env:USERPROFILE\.ccache" >> $env:GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $env:GITHUB_ENV
          ccache --version
        shell: pwsh

      - name: Set up CMake (all platforms)
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.30'

      - name: Configure CMake (${{ matrix.edition }}) - Linux
        if: runner.os == 'Linux'
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export PYTHON_EXECUTABLE=/usr/bin/python3.11
          CYTHON_EXECUTABLE=$(which cython)
          cmake --preset=${{ matrix.edition == 'PRO' && 'pro' || 'standard' }} -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DPython_EXECUTABLE=$PYTHON_EXECUTABLE -DCYTHON_EXECUTABLE=$CYTHON_EXECUTABLE
        shell: bash

      - name: Configure CMake (${{ matrix.edition }}) - macOS
        if: runner.os == 'macOS'
        run: |
          export PATH="/tmp/bin:/usr/local/bin:/opt/homebrew/bin:$PATH"
          # Find Python 3.11 from brew
          PYTHON_311=$(which python3.11)
          if [ -z "$PYTHON_311" ]; then
            # Fallback to direct Cellar path lookup (works on both Intel and arm64)
            PYTHON_311=$(find /usr/local/Cellar/python@3.11 /opt/homebrew/Cellar/python@3.11 -name "python3.11" -type f 2>/dev/null | head -1)
          fi
          if [ -z "$PYTHON_311" ]; then
            echo "ERROR: Could not find python3.11"
            exit 1
          fi
          # Create symlink if it doesn't exist
          mkdir -p /tmp/bin
          ln -sf $PYTHON_311 /tmp/bin/python3.11 2>/dev/null || true
          PYTHON_EXECUTABLE=/tmp/bin/python3.11
          CYTHON_EXECUTABLE=$(which cython)
          # Get NumPy include directory
          NUMPY_INCLUDE=$($PYTHON_EXECUTABLE -c "import numpy; print(numpy.get_include())")
          echo "Using Python: $PYTHON_EXECUTABLE"
          echo "Using Cython: $CYTHON_EXECUTABLE"
          echo "Using NumPy include: $NUMPY_INCLUDE"
          cmake --preset=${{ matrix.edition == 'PRO' && 'pro' || 'standard' }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DPython3_EXECUTABLE=$PYTHON_EXECUTABLE \
            -DPython3_NumPy_INCLUDE_DIR=$NUMPY_INCLUDE \
            -DCYTHON_EXECUTABLE=$CYTHON_EXECUTABLE
        shell: bash

      - name: Configure CMake (${{ matrix.edition }}) - Windows
        if: runner.os == 'Windows'
        run: |
          REM Initialize MSVC environment (x64)
          for /f "delims=" %%i in ('vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath') do set VSINSTALLDIR=%%i
          if not defined VSINSTALLDIR (
            echo ERROR: Unable to locate a suitable Visual Studio installation
            exit /b 1
          )
          call "%VSINSTALLDIR%\VC\Auxiliary\Build\vcvars64.bat" >nul
          REM Find Python 3.11 from setup-python action
          for /f "delims=" %%i in ('where python.exe') do (
            %%i --version 2>&1 | findstr "3.11" >nul && set PYTHON_EXECUTABLE=%%i && goto found_python
          )
          :found_python
          if not defined PYTHON_EXECUTABLE (
            echo ERROR: Python 3.11 not found
            exit /b 1
          )
          echo Found Python at: %PYTHON_EXECUTABLE%
          %PYTHON_EXECUTABLE% --version
          REM Get NumPy include directory
          for /f "delims=" %%i in ('%PYTHON_EXECUTABLE% -c "import numpy; print(numpy.get_include())"') do set NUMPY_INCLUDE=%%i
          REM Get Python include directory
          for /f "delims=" %%i in ('%PYTHON_EXECUTABLE% -c "import sysconfig; print(sysconfig.get_path(\"include\"))"') do set PYTHON_INCLUDE=%%i
          REM Find Cython
          where cython > nul 2>&1 && (
            for /f "delims=" %%i in ('where cython') do set CYTHON_EXECUTABLE=%%i
          ) || (
            echo ERROR: cython not found
            exit /b 1
          )
          echo Using Python: %PYTHON_EXECUTABLE%
          echo Using Python Include: %PYTHON_INCLUDE%
          echo Using NumPy: %NUMPY_INCLUDE%
          echo Using Cython: %CYTHON_EXECUTABLE%
          cmake --preset=${{ matrix.edition == 'PRO' && 'pro' || 'standard' }} ^
            -DCMAKE_C_COMPILER=cl.exe ^
            -DCMAKE_CXX_COMPILER=cl.exe ^
            -DPython3_EXECUTABLE=%PYTHON_EXECUTABLE% ^
            -DPython3_INCLUDE_DIR=%PYTHON_INCLUDE% ^
            -DPython3_NumPy_INCLUDE_DIR=%NUMPY_INCLUDE% ^
            -DCYTHON_EXECUTABLE=%CYTHON_EXECUTABLE%
        shell: cmd

      - name: Build (${{ matrix.edition }})
        run: cmake --build --preset=${{ matrix.preset }}
        shell: bash

      - name: Show ccache stats
        run: ccache --show-stats
        shell: bash

      - name: Verify binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          file splatter/bin/splatter_engine
          if command -v ldd &> /dev/null; then
            echo "=== Dynamic dependencies ==="
            ldd splatter/bin/splatter_engine || true
          elif command -v otool &> /dev/null; then
            echo "=== Dynamic dependencies (macOS) ==="
            otool -L splatter/bin/splatter_engine || true
          fi
        shell: bash

      - name: Verify binary (Windows)
        if: runner.os == 'Windows'
        run: |
          powershell -Command "file splatter/bin/splatter_engine.exe" || dir splatter\bin\splatter_engine.exe
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: splatter-engine-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.edition }}
          path: splatter/bin/splatter_engine*
          retention-days: 30

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
