name: Build Pivot Engine

on:
  push:
    branches: [main, dev, dev2]
    paths:
      - 'engine/**'
      - 'core/**'
      - 'cython/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main, dev, dev2]
    paths:
      - 'engine/**'
      - 'core/**'
      - 'cython/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'

jobs:
  build:
    name: Build ${{ matrix.edition }} on ${{ matrix.os }}
    runs-on: ${{ matrix.runs-on }}
    
    strategy:
      matrix:
        include:
          # Linux x86-64
          # - os: linux
          #   arch: x86-64
          #   runs-on: ubuntu-22.04
          #   edition: PRO
          #   preset: pro-release
            
          # - os: linux
          #   arch: x86-64
          #   runs-on: ubuntu-22.04
          #   edition: STANDARD
          #   preset: standard-release

          # # macOS x86-64 (Intel)
          # - os: macos
          #   arch: x86-64
          #   runs-on: macos-15-intel
          #   edition: PRO
          #   preset: pro-release
            
          # - os: macos
          #   arch: x86-64
          #   runs-on: macos-15-intel
          #   edition: STANDARD
          #   preset: standard-release

          # # macOS arm64 (Apple Silicon)
          # - os: macos
          #   arch: arm64
          #   runs-on: macos-latest
          #   edition: PRO
          #   preset: pro-release
            
          # - os: macos
          #   arch: arm64
          #   runs-on: macos-latest
          #   edition: STANDARD
          #   preset: standard-release

          # Windows x86-64
          - os: windows
            arch: x86-64
            runs-on: windows-latest
            edition: PRO
            preset: pro-release
            
          - os: windows
            arch: x86-64
            runs-on: windows-latest
            edition: STANDARD
            preset: standard-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-${{ runner.arch }}-ccache-${{ hashFiles('engine/**', 'core/**', 'cython/**', 'CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-ccache-

      - name: Set up dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y \
            cmake \
            ninja-build \
            g++ \
            python3.11-dev \
            python3-pip \
            ccache
          python3.11 -m pip install --user cython numpy
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Set up ccache (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
          ccache --version

      - name: Install dependencies - macOS
        if: runner.os == 'macOS'
        run: |
          brew update
          # Remove conflicting symlinks before installing
          rm -f /usr/local/bin/python3.11 /usr/local/bin/python3.11-config /usr/local/bin/python3 /usr/local/bin/pip3.11 2>/dev/null || true
          rm -f /opt/homebrew/bin/python3.11 /opt/homebrew/bin/python3.11-config 2>/dev/null || true
          brew install cmake ninja python@3.11 ccache || brew link --overwrite python@3.11
          # Find Python 3.11 from brew (works on both Intel and arm64)
          PYTHON_311=$(which python3.11)
          if [ -z "$PYTHON_311" ]; then
            # Fallback to direct Cellar path lookup
            PYTHON_311=$(find /usr/local/Cellar/python@3.11 /opt/homebrew/Cellar/python@3.11 -name "python3.11" -type f 2>/dev/null | head -1)
          fi
          if [ -z "$PYTHON_311" ]; then
            echo "ERROR: Could not find python3.11"
            exit 1
          fi
          $PYTHON_311 -m pip install --break-system-packages cython numpy
        shell: bash
          
      - name: Create cython wrapper (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p /tmp/bin
          cat > /tmp/bin/cython << 'EOF'
          #!/bin/bash
          exec /tmp/bin/python3.11 -m cython "$@"
          EOF
          chmod +x /tmp/bin/cython

      - name: Set up ccache (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
          ccache --version

      - name: Set up Python 3.11 (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Set up dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install -y ninja
          & "$env:pythonLocation\python.exe" -m pip install --upgrade pip
          & "$env:pythonLocation\python.exe" -m pip install cython numpy

      - name: Set up MSVC toolchain (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Set up CMake (all platforms)
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.30'

      - name: Configure CMake (${{ matrix.edition }}) - Linux
        if: runner.os == 'Linux'
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export PYTHON_EXECUTABLE=/usr/bin/python3.11
          CYTHON_EXECUTABLE=$(which cython)
          cmake --preset=${{ matrix.edition == 'PRO' && 'pro' || 'standard' }} -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DPython3_EXECUTABLE=$PYTHON_EXECUTABLE -DCYTHON_EXECUTABLE=$CYTHON_EXECUTABLE
        shell: bash

      - name: Configure CMake (${{ matrix.edition }}) - macOS
        if: runner.os == 'macOS'
        run: |
          export PATH="/tmp/bin:/usr/local/bin:/opt/homebrew/bin:$PATH"
          # Find Python 3.11 from brew
          PYTHON_311=$(which python3.11)
          if [ -z "$PYTHON_311" ]; then
            # Fallback to direct Cellar path lookup (works on both Intel and arm64)
            PYTHON_311=$(find /usr/local/Cellar/python@3.11 /opt/homebrew/Cellar/python@3.11 -name "python3.11" -type f 2>/dev/null | head -1)
          fi
          if [ -z "$PYTHON_311" ]; then
            echo "ERROR: Could not find python3.11"
            exit 1
          fi
          # Create symlink if it doesn't exist
          mkdir -p /tmp/bin
          ln -sf $PYTHON_311 /tmp/bin/python3.11 2>/dev/null || true
          PYTHON_EXECUTABLE=/tmp/bin/python3.11
          CYTHON_EXECUTABLE=$(which cython)
          # Get NumPy include directory
          NUMPY_INCLUDE=$($PYTHON_EXECUTABLE -c "import numpy; print(numpy.get_include())")
          echo "Using Python: $PYTHON_EXECUTABLE"
          echo "Using Cython: $CYTHON_EXECUTABLE"
          echo "Using NumPy include: $NUMPY_INCLUDE"
          cmake --preset=${{ matrix.edition == 'PRO' && 'pro' || 'standard' }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DPython3_EXECUTABLE=$PYTHON_EXECUTABLE \
            -DPython3_NumPy_INCLUDE_DIR=$NUMPY_INCLUDE \
            -DCYTHON_EXECUTABLE=$CYTHON_EXECUTABLE
        shell: bash

      - name: Configure CMake (${{ matrix.edition }}) - Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ('${{ matrix.edition }}' -eq 'PRO') {
            $preset = 'pro'
          } else {
            $preset = 'standard'
          }
          $python = Join-Path $env:pythonLocation 'python.exe'
          $cython = Join-Path $env:pythonLocation 'Scripts\cython.exe'
          if (-not (Test-Path $cython)) {
            throw "cython executable not found at $cython"
          }
          cmake --preset=$preset `
            "-DPython3_ROOT_DIR=$env:pythonLocation" `
            "-DPython3_EXECUTABLE=$python" `
            "-DPython3_FIND_STRATEGY=LOCATION" `
            "-DPython3_FIND_REGISTRY=NEVER" `
            "-DPython3_FIND_VIRTUALENV=FIRST" `
            "-DCYTHON_EXECUTABLE=$cython"

      - name: Build (${{ matrix.edition }}) - Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: cmake --build --preset=${{ matrix.preset }}

      - name: Build (${{ matrix.edition }}) - Linux/macOS
        if: runner.os != 'Windows'
        run: cmake --build --preset=${{ matrix.preset }}
        shell: bash

      - name: Show ccache stats
        if: runner.os != 'Windows'
        run: ccache --show-stats
        shell: bash

      - name: Verify binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          engine_path=$(find pivot/bin -maxdepth 2 -type f -name pivot_engine -print -quit)
          if [ -z "$engine_path" ]; then
            echo "ERROR: Engine binary not found under pivot/bin"
            ls -R pivot/bin || true
            exit 1
          fi
          echo "Using engine binary: $engine_path"
          file "$engine_path"
          if command -v ldd &> /dev/null; then
            echo "=== Dynamic dependencies ==="
            ldd "$engine_path" || true
          elif command -v otool &> /dev/null; then
            echo "=== Dynamic dependencies (macOS) ==="
            otool -L "$engine_path" || true
          fi
        shell: bash

      - name: Verify binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $enginePath = Get-ChildItem -Path "pivot\bin" -Filter "pivot_engine.exe" -File -Recurse | Select-Object -First 1
          if ($null -ne $enginePath) {
            Get-Item $enginePath.FullName
          } else {
            Write-Error "pivot\\bin\\pivot_engine.exe not found in any subdirectory"
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pivot-engine-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.edition }}
          path: |
            pivot/bin/
            pivot/lib/
          retention-days: 30

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create universal addon packages (STANDARD and PRO)
        run: |
          # Check out pivot addon structure for packaging
          mkdir -p pivot-addon-base
          
          # Create separate packages for STANDARD and PRO editions
          for edition in STANDARD PRO; do
            echo "Building universal package for $edition edition"
            addon_dir="pivot-addon-$edition"
            
            # Copy the pivot addon structure
            cp -r pivot "$addon_dir"
            mkdir -p "$addon_dir/bin" "$addon_dir/lib"
            
            # Extract and organize binaries from platform artifacts for this edition
            for artifact_dir in artifacts/*/; do
              if [[ -d "$artifact_dir" ]]; then
                artifact_name=$(basename "$artifact_dir")
                # Normalize artifact name (e.g., pivot-engine-windows-x86-64-PRO)
                platform=$(echo "$artifact_name" | sed -E 's/pivot-engine-([^-]+-[^-]+)-.*/\1/')
                # Convert macos-* to darwin-*
                platform=${platform/macos/darwin}
                artifact_edition=$(echo "$artifact_name" | sed -E 's/.*-([A-Z]+)$/\1/')
                
                # Skip if this artifact is not for the current edition
                if [[ "$artifact_edition" != "$edition" ]]; then
                  echo "Skipping $artifact_name (not $edition)"
                  continue
                fi

                src_root="$artifact_dir"
                if [[ -d "$artifact_dir/pivot" ]]; then
                  src_root="$artifact_dir/pivot"
                fi

                # Copy engine binary to platform-specific directory
                mkdir -p "$addon_dir/bin/$platform"
                engine_path=$(find "$src_root/bin" -maxdepth 3 -type f \( -name 'pivot_engine' -o -name 'pivot_engine.exe' \) | head -n1)
                if [[ -n "$engine_path" ]]; then
                  dest_engine="$addon_dir/bin/$platform/pivot_engine"
                  if [[ $engine_path == *.exe ]]; then
                    dest_engine+=".exe"
                  fi
                  echo "Copying $edition engine from $engine_path -> $dest_engine"
                  cp "$engine_path" "$dest_engine"
                else
                  echo "WARNING: No engine binary found for $edition in $artifact_dir"
                fi

                # Copy Cython modules to platform-specific directory
                mkdir -p "$addon_dir/lib/$platform"
                if [[ -d "$src_root/lib/$platform" ]]; then
                  echo "Copying $edition Cython modules for $platform from lib/$platform"
                  find "$src_root/lib/$platform" -type f \( -name "*.so" -o -name "*.pyd" \) | while read module; do
                    cp "$module" "$addon_dir/lib/$platform/" 2>/dev/null || true
                  done
                elif [[ -d "$src_root/lib" ]]; then
                  echo "Copying $edition Cython modules for $platform from lib (no platform subdir)"
                  find "$src_root/lib" -maxdepth 1 -type f \( -name "*.so" -o -name "*.pyd" \) | while read module; do
                    cp "$module" "$addon_dir/lib/$platform/" 2>/dev/null || true
                  done
                else
                  echo "WARNING: No Cython modules found for $edition in $artifact_dir"
                fi
              fi
            done
            
            # Verify we got binaries and modules for this edition
            if [[ -z $(find "$addon_dir/bin" -type f -name 'pivot_engine*' -print -quit) ]]; then
              echo "ERROR: No engine binaries found for $edition!"
              exit 1
            fi
            
            # Create the edition-specific zip with pivot folder at root
            zip -r "pivot-addon-$edition.zip" "$addon_dir"
            
            echo "Created $edition addon package: pivot-addon-$edition.zip"
          done

      - name: Upload STANDARD addon
        uses: actions/upload-artifact@v4
        with:
          name: pivot-addon-STANDARD
          path: pivot-addon-STANDARD.zip
          retention-days: 30

      - name: Upload PRO addon
        uses: actions/upload-artifact@v4
        with:
          name: pivot-addon-PRO
          path: pivot-addon-PRO.zip
          retention-days: 30
